<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="../Img/vtlogo.png" />
    <title>Quản lý bài viết | Thanh Trung Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.2.1/classic/ckeditor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="../assets/auth-guard.js"></script>

    <style>
      .sidebar {
        /* z-index cao để luôn nằm trên cùng */
        z-index: 50;
        transition: transform 0.3s ease-in-out;
      }
      .content-area {
        transition: margin-left 0.3s ease-in-out;
      }
    
      /* CSS cho màn hình mobile */
      @media (max-width: 768px) {
        .sidebar {
          /* Mặc định ẩn sidebar ra ngoài màn hình bên trái */
          transform: translateX(-100%);
        }
        .sidebar.active {
          /* Khi có class active, trượt sidebar vào trong màn hình */
          transform: translateX(0);
        }
        .content-area {
          /* Trên mobile, content luôn chiếm toàn bộ chiều rộng */
          margin-left: 0 !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar (same as index.html) -->
      <div
        class="sidebar bg-white w-64 md:w-20 lg:w-64 fixed h-full shadow-md z-50"
      >
        <div
          class="flex items-center justify-center h-16 border-b border-gray-200"
        >
          <div class="text-blue-600 font-bold text-xl lg:block hidden">
            VanThangMedia
          </div>
          <div
            class="text-blue-600 font-bold text-xl lg:hidden md:block hidden"
          >
            TTM
          </div>
        </div>
        <nav class="mt-4">
          <div class="px-4">
            <div
              class="text-gray-500 uppercase text-xs font-semibold tracking-wider lg:block hidden"
            >
              Main
            </div>
            <a
              href="./admin.html"
              class="flex items-center mt-3 py-2 px-4 hover:bg-blue-50 hover:text-blue-600 rounded-lg"
            >
              <i data-feather="home" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Dashboard</span>
            </a>
            <a
              href="./posts.html"
              class="flex items-center mt-3 py-2 px-4 bg-blue-50 text-blue-600 rounded-lg"
            >
              <i data-feather="file-text" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Bài viết</span>
            </a>
            <a
              href="./categories.html"
              class="flex items-center mt-3 py-2 px-4 hover:bg-blue-50 hover:text-blue-600 rounded-lg"
            >
              <i data-feather="folder" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Danh mục</span>
            </a>
            <a
              href="./comments.html"
              class="flex items-center mt-3 py-2 px-4 hover:bg-blue-50 hover:text-blue-600 rounded-lg"
            >
              <i data-feather="message-square" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Bình luận</span>
            </a>
          </div>
          <div class="px-4 mt-8">
            <div
              class="text-gray-500 uppercase text-xs font-semibold tracking-wider lg:block hidden"
            >
              User
            </div>
            <a
              href="#"
              class="flex items-center mt-3 py-2 px-4 hover:bg-blue-50 hover:text-blue-600 rounded-lg"
            >
              <i data-feather="users" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Tài khoản</span>
            </a>
            <a
              href="#"
              class="flex items-center mt-3 py-2 px-4 hover:bg-blue-50 hover:text-blue-600 rounded-lg"
            >
              <i data-feather="settings" class="w-5 h-5"></i>
              <span class="ml-3 lg:block md:hidden">Cài đặt</span>
            </a>
          </div>
        </nav>
      </div> <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
      <!-- Main Content -->
      <div
        class="content-area flex-1 flex flex-col overflow-hidden ml-0 md:ml-20 lg:ml-64"
      >
        <!-- Top Header (same as index.html) -->
        <header class="bg-white shadow-sm">
          <div class="flex items-center justify-between px-6 py-3">
            <div class="flex items-center">
              <button
                id="sidebarToggle"
                class="text-gray-500 focus:outline-none lg:hidden"
              >
                <i data-feather="menu" class="w-6 h-6"></i>
              </button>
              <!-- <div class="relative mx-4 lg:block hidden">
                <input
                  type="text"
                  class="w-64 pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Tìm kiếm..."
                />
                <i
                  data-feather="search"
                  class="absolute left-3 top-2.5 text-gray-400"
                ></i>
              </div> -->
            </div>
            <div class="flex items-center space-x-4">
              <button class="text-gray-500 focus:outline-none relative">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span
                  class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500"
                ></span>
              </button>
              <div class="dropdown relative">
                <button class="flex items-center focus:outline-none">
                  <img
                    src="../Img/AnhFB/anhavata2 (2).jpg"
                    class="w-8 h-8 rounded-full"
                    alt="User"
                  />
                  <span class="ml-2 text-gray-700 font-medium lg:block hidden"
                    >Admin</span
                  >
                  <!-- <i
                    data-feather="chevron-down"
                    class="ml-1 w-4 h-4 text-gray-500 lg:block hidden"
                  ></i> -->
                </button>
                <div
                  class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 transition ease-out duration-100 transform opacity-0 scale-95 pointer-events-none"
                >
                  <a
                    href="#"
                    class="block px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                    >Hồ sơ cá nhân</a
                  >
                  <a
                    href="#"
                    class="block px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                    >Đổi mật khẩu</a
                  >
                  <div class="border-t border-gray-200"></div>
                  <a
                    href="login.html"
                    class="block px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600"
                    >Đăng xuất</a
                  >
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
          <div class="mb-6 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-800">Quản lý bài viết</h1>
            <a
              href="add-post.html"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center"
            >
              <i data-feather="plus" class="w-4 h-4 mr-2"></i>
              Tạo bài viết mới
            </a>
          </div>

          <!-- Filters -->
          <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div
              class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0"
            >
              <div class="relative w-full md:w-64">
                <input
                  type="text"
                  id="searchInput" class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Tìm kiếm theo tiêu đề..."
                />
                <i
                  data-feather="search"
                  class="absolute left-3 top-2.5 text-gray-400"
                ></i>
              </div>
              <div class="flex space-x-2">
                <select
                  id="statusFilter" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="all">Tất cả trạng thái</option>
                  <option value="published">Đã đăng</option>
                  <option value="draft">Nháp</option>
                </select>
                </div>
            </div>
          </div>
        
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Tiêu đề
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Tác giả
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ngày đăng
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Trạng thái
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Hành động
                    </th>
                  </tr>
                </thead>
                <tbody id="postsTableBody" class="bg-white divide-y divide-gray-200">
                  <tr>
                     <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                        Đang tải dữ liệu...
                     </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div
              id="pagination" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between"
            >
              </div>
          </div>
        </main>
        
        <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <div class="text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
              <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5">Xóa bài viết</h3>
              <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Bạn có chắc chắn muốn xóa bài viết này không? Hành động này không thể hoàn tác.</p>
              </div>
              <div class="mt-4 flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                  Đồng ý xóa
                </button>
                <button id="cancel-delete-btn" class="px-4 py-2 bg-white text-gray-700 text-base font-medium rounded-md shadow-sm border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  Hủy bỏ
                </button>
              </div>
            </div>
          </div>
        </div>
        </main>
      </div>
    </div>

    <!-- modal edit post -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
      <div class="bg-gray-50 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between p-4 border-b">
          <h2 class="text-xl font-bold text-gray-800">Chỉnh sửa bài viết</h2>
          <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
            <i data-feather="x" class="w-6 h-6"></i>
          </button>
        </div>
    
        <div class="p-6 overflow-y-auto">
          <form id="edit-form">
            <input type="hidden" id="edit-post-id" />
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2">
                <div class="mb-6">
                  <label for="edit-title" class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề bài viết</label>
                  <input type="text" id="edit-title" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập tiêu đề..." />
                </div>
                <div class="mb-6">
                  <label for="edit-slug" class="block text-sm font-medium text-gray-700 mb-1">Đường dẫn (Slug)</label>
                  <input type="text" id="edit-slug" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="duong-dan-bai-viet" />
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nội dung bài viết</label>
                  <div id="edit-editor"></div> 
                </div>
              </div>
              <div class="lg:col-span-1">
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Ảnh đại diện</label>
                  <div class="mt-1 p-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="text-center">
                      <img id="edit-preview-image" src="" alt="Preview" class="w-full h-auto rounded-lg shadow mb-4" />
                      <label for="edit-file-upload" class="cursor-pointer font-medium text-blue-600 hover:text-blue-500">
                        <span>Thay đổi ảnh</span>
                        <input id="edit-file-upload" type="file" accept="image/*" class="sr-only" />
                      </label>
                      <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF tối đa 10MB</p>
                    </div>
                  </div>
                </div>
                <div class="mb-6">
                  <label for="edit-excerpt" class="block text-sm font-medium text-gray-700 mb-1">Tóm tắt</label>
                  <textarea id="edit-excerpt" rows="4" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                </div>
            </div>
          </form>
        </div>
    
        <div class="flex items-center justify-end p-4 border-t bg-gray-100 rounded-b-lg space-x-2">
          <button id="cancel-edit-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Hủy</button>
          <button id="save-draft-btn" type="submit" form="edit-form" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Lưu nháp
          </button>
          <button id="publish-btn" type="submit" form="edit-form" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Xuất bản
          </button>
        </div>
      </div>
    </div>

    <div
    id="notification-modal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300"
  >
    <div
      class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-transform duration-300 scale-95"
    >
      <div class="flex items-start">
        <div id="modal-icon" class="mr-4">
          <svg
            id="modal-icon-success"
            class="hidden w-8 h-8 text-green-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <svg
            id="modal-icon-error"
            class="hidden w-8 h-8 text-red-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
  
        <div class="flex-1">
          <h3 id="modal-title" class="text-xl font-semibold text-gray-800">
            Tiêu đề thông báo
          </h3>
          <p id="modal-message" class="text-sm text-gray-600 mt-2">
            Nội dung chi tiết ở đây.
          </p>
        </div>
      </div>
  
      <div class="mt-6 text-right">
        <button
          id="modal-close-btn"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
        >
          Đã hiểu
        </button>
      </div>
    </div>
  </div>

    <!-- <script>
      feather.replace();
      const dropdownButton = document.querySelector(".dropdown button");
      const dropdownMenu = document.querySelector(".dropdown-menu");
      const dropdownIcon = document.getElementById("dropdown-icon"); // [MỚI] Lấy ra thẻ icon

      // Các lớp định nghĩa trạng thái "hiện" của menu
      const activeClasses = ["opacity-100", "scale-100", "pointer-events-auto"];
      // Các lớp định nghĩa trạng thái "ẩn" của menu
      const inactiveClasses = ["opacity-0", "scale-95", "pointer-events-none"];

      // 2. Thêm sự kiện "click" cho nút dropdown
      dropdownButton.addEventListener("click", function (event) {
        event.stopPropagation();
        const isHidden = dropdownMenu.classList.contains("opacity-0");

        if (isHidden) {
          console.log(isHidden);
          // Nếu đang ẩn -> Hiện nó ra
          dropdownMenu.classList.remove(...inactiveClasses);
          dropdownMenu.classList.add(...activeClasses);
          // [MỚI] Đổi icon thành "up"
          dropdownIcon.setAttribute("data-feather", "chevron-up");
        } else {
          console.log(isHidden);
          // Nếu đang hiện -> Ẩn nó đi
          dropdownMenu.classList.remove(...activeClasses);
          dropdownMenu.classList.add(...inactiveClasses);
          // [MỚI] Đổi icon thành "down"
          dropdownIcon.setAttribute("data-feather", "chevron-down");
        }
        // [MỚI] Yêu cầu Feather Icons vẽ lại icon vừa được thay đổi
        feather.replace();
      });

      // 3. Đóng dropdown khi nhấp ra bên ngoài
      window.addEventListener("click", function () {
        event.stopPropagation();
        if (dropdownMenu.classList.contains("opacity-100")) {
          dropdownMenu.classList.remove(...activeClasses);
          dropdownMenu.classList.add(...inactiveClasses);
          // [MỚI] Đổi icon về "down" khi đóng menu
          dropdownIcon.setAttribute("data-feather", "chevron-down");
          // [MỚI] Yêu cầu Feather Icons vẽ lại
          feather.replace();
        }
      });

      // Sidebar Toggle
      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          document.querySelector(".sidebar").classList.toggle("active");
        });

      // Responsive sidebar behavior
      function handleSidebar() {
        const sidebar = document.querySelector(".sidebar");
        const content = document.querySelector(".content-area");

        if (window.innerWidth < 768) {
          sidebar.classList.remove("active");
        } else if (window.innerWidth < 1024) {
          sidebar.classList.add("active");
        } else {
          sidebar.classList.remove("active");
        }
      }

      window.addEventListener("resize", handleSidebar);
      handleSidebar();
    </script> -->
  <!-- <script>// Đợi cho toàn bộ cây DOM được tải xong rồi mới chạy script
  const modal = document.getElementById("notification-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalIconSuccess = document.getElementById("modal-icon-success");
    const modalIconError = document.getElementById("modal-icon-error");
    const modalCloseBtn = document.getElementById("modal-close-btn");
    
    /**
     * Hiển thị modal với nội dung tùy chỉnh.
     * @param {string} title Tiêu đề modal.
     * @param {string} message Nội dung thông báo (có thể chứa HTML).
     * @param {'success' | 'error'} type Loại thông báo.
     */
    function showModal(title, message, type = 'error') {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message; // Dùng innerHTML để có thể render list lỗi
    
        if (type === 'success') {
            modalIconSuccess.classList.remove('hidden');
            modalIconError.classList.add('hidden');
        } else {
            modalIconError.classList.remove('hidden');
            modalIconSuccess.classList.add('hidden');
        }
        
        modal.classList.remove('hidden');
        // Thêm animation khi hiện
        setTimeout(() => modal.querySelector('div.transform').classList.replace('scale-95', 'scale-100'), 10);
    }
    
    function hideModal() {
        modal.querySelector('div.transform').classList.replace('scale-100', 'scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300); // Đợi animation xong rồi mới ẩn
    }
    modalCloseBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
        // Nếu click vào background mờ thì cũng đóng modal
        if (e.target === modal) {
            hideModal();
        }
    });
    
   document.addEventListener("DOMContentLoaded", () => {
    // --- 1. KHAI BÁO BIẾN VÀ HẰNG SỐ ---
    const API_URL = "http://localhost:5000/api/posts";
    const POSTS_PER_PAGE = 10;

    // DOM Elements - Trang chính
    const tableBody = document.getElementById("postsTableBody");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const paginationContainer = document.getElementById("pagination");

    // DOM Elements - Modal Xóa
    const deleteModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    // DOM Elements - Modal Chỉnh sửa
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const editPostIdInput = document.getElementById('edit-post-id');
    const editTitleInput = document.getElementById('edit-title');
    const editSlugInput = document.getElementById('edit-slug');
    const editExcerptTextarea = document.getElementById('edit-excerpt');
    const editFileUpload = document.getElementById('edit-file-upload');
    const editPreviewImage = document.getElementById('edit-preview-image');
    // const editStatusSelect = document.getElementById('edit-status'); // Bỏ biến này đi

    // Biến trạng thái
    let allPosts = [];
    let filteredPosts = [];
    let currentPage = 1;
    let postIdToDelete = null;
    let editEditorInstance = null;

    // --- Cấu hình CKEditor Upload Adapter ---
    class MyUploadAdapter {
        constructor(loader) { this.loader = loader; }
        upload() {
            return this.loader.file.then(file => new Promise((resolve, reject) => {
                const data = new FormData();
                data.append("upload", file);
                fetchWithAuth("http://localhost:5000/api/upload", { method: "POST", body: data })
                    .then(response => response.json())
                    .then(result => resolve({ default: result.url }))
                    .catch(err => reject(err));
            }));
        }
        abort() {}
    }
    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get("FileRepository").createUploadAdapter = (loader) => new MyUploadAdapter(loader);
    }
    
    // --- 2. CÁC HÀM CORE ---
    async function fetchPosts() { try { const response = await fetchWithAuth(API_URL); if (!response.ok) throw new Error("Network response was not ok"); allPosts = await response.json(); filteredPosts = [...allPosts]; currentPage = 1; render(); } catch (error) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-red-500">${error.message}</td></tr>`; } }
    function renderTable() { if (filteredPosts.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-gray-500">Không có bài viết nào.</td></tr>`; return; } const startIndex = (currentPage - 1) * POSTS_PER_PAGE; const endIndex = startIndex + POSTS_PER_PAGE; const postsForCurrentPage = filteredPosts.slice(startIndex, endIndex); tableBody.innerHTML = postsForCurrentPage.map(post => { const statusClass = post.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'; const statusText = post.status === 'published' ? 'Đã đăng' : 'Nháp'; const authorName = post.author ? post.author.name : 'Admin'; return `<tr><td class="px-6 py-4"><div class="flex items-center"><div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-md object-cover" src="${post.image_url || 'https://via.placeholder.com/150'}" alt="${post.title}"></div><div class="ml-4"><div class="text-sm font-medium text-gray-900 truncate" style="max-width: 250px;">${post.title}</div><div class="text-sm text-gray-500">${post.slug}</div></div></div></td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${authorName}</div></td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${new Date(post.created_at).toLocaleDateString('vi-VN')}</div></td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><div class="flex space-x-2"><a href="#" class="edit-btn text-blue-600 hover:text-blue-900" data-id="${post.id}" title="Chỉnh sửa"><i data-feather="edit" class="w-4 h-4"></i></a><button class="delete-btn text-red-600 hover:text-red-900" data-id="${post.id}" title="Xóa"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></td></tr>`; }).join(''); feather.replace(); }
    function renderPagination() { const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE); if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; } let paginationHTML = `<div class="text-sm text-gray-500">Hiển thị <span class="font-medium">${(currentPage - 1) * POSTS_PER_PAGE + 1}</span> đến <span class="font-medium">${Math.min(currentPage * POSTS_PER_PAGE, filteredPosts.length)}</span> của <span class="font-medium">${filteredPosts.length}</span> kết quả</div><div class="flex space-x-2">`; paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Trước</button>`; for (let i = 1; i <= totalPages; i++) { const isActive = i === currentPage; paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${isActive ? 'border-blue-600 text-white bg-blue-600' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${i}">${i}</button>`; } paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Sau</button>`; paginationHTML += `</div>`; paginationContainer.innerHTML = paginationHTML; }
    function render() { renderTable(); renderPagination(); }
    
    // --- 3. LOGIC MODAL CHỈNH SỬA ---
    async function openEditModal(postId) {
    try {
        // Hiển thị một trạng thái loading tạm thời (tùy chọn)
        // Ví dụ: Mở modal với một spinner...

        // BƯỚC 1: Gọi API chi tiết để lấy dữ liệu ĐẦY ĐỦ
        const response = await fetchWithAuth(`${API_URL}/${postId}`);
        if (!response.ok) {
            throw new Error("Không thể tải dữ liệu chi tiết bài viết.");
        }
        const post = await response.json(); // Dữ liệu bài viết đầy đủ với 'content'

        // BƯỚC 2: Điền dữ liệu đầy đủ vào form
        editPostIdInput.value = post.id;
        editTitleInput.value = post.title;
        editSlugInput.value = post.slug;
        editExcerptTextarea.value = post.summary || '';
        editPreviewImage.src = post.image_url;
        editFileUpload.value = '';

        // BƯỚC 3: Hiển thị modal và khởi tạo CKEditor
        editModal.classList.remove('hidden');
        feather.replace();

        if (editEditorInstance) {
            await editEditorInstance.destroy();
            editEditorInstance = null;
        }

        const editor = await ClassicEditor.create(document.querySelector("#edit-editor"), {
            extraPlugins: [MyCustomUploadAdapterPlugin],
            initialData: post.content || '', // Bây giờ post.content đã có dữ liệu!
        });
        editEditorInstance = editor;

    } catch (error) {
        console.error("Lỗi khi mở modal chỉnh sửa:", error);
        // Tích hợp modal thông báo ở đây
        showModal("Thao tác thất bại", `Lỗi: ${error.message}`, 'error');
    }
}

    function closeEditModal() {
        editModal.classList.add('hidden');
        if (editEditorInstance) {
            editEditorInstance.destroy().catch(error => console.error(error));
            editEditorInstance = null;
        }
    }
    
    // CẬP NHẬT HÀM NÀY
    async function handleUpdatePost(e) {
    e.preventDefault();
    const submitter = e.submitter;
    if (!submitter) return;

    const status = submitter.id === 'publish-btn' ? 'published' : 'draft';
    const postId = editPostIdInput.value;

    // --- Bắt đầu VALIDATION (MỚI) ---
    const title = editTitleInput.value.trim();
    const content = editEditorInstance.getData();
    const errors = [];
    if (!title) {
        errors.push("<li>Tiêu đề không được để trống.</li>");
    }
    if (!content || content.replace(/<(.|\n)*?>/g, '').trim().length === 0) {
        errors.push("<li>Nội dung bài viết không được để trống.</li>");
    }
    
    // Nếu có lỗi, hiển thị modal lỗi và dừng lại
    if (errors.length > 0) {
        showModal(
            "Dữ liệu không hợp lệ",
            `<ul class="list-disc list-inside">${errors.join("")}</ul>`,
            'error'
        );
        return;
    }
    // --- Kết thúc VALIDATION ---
    
    const formData = new FormData();
    formData.append('title', title);
    formData.append('slug', editSlugInput.value.trim());
    formData.append('summary', editExcerptTextarea.value.trim());
    formData.append('content', content);
    formData.append('status', status);

    if (editFileUpload.files[0]) {
        formData.append('image', editFileUpload.files[0]);
    }
    
    submitter.textContent = 'Đang xử lý...';
    submitter.disabled = true;

    try {
        const response = await fetchWithAuth(`${API_URL}/${postId}`, {
            method: 'PUT',
            body: formData,
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Cập nhật thất bại');
        }

        closeEditModal();
        showModal("Thành công!", "Bài viết đã được cập nhật thành công.", "success");
        await fetchPosts();
        
    } catch (error) {
        console.error(error);
        showModal("Thao tác thất bại", `Lỗi: ${error.message}`, 'error');
    } finally {
        submitter.textContent = status === 'published' ? 'Xuất bản' : 'Lưu nháp';
        submitter.disabled = false;
    }
}

    // --- 4. CÁC HÀM XỬ LÝ SỰ KIỆN ---
    function applyFilters() { const searchTerm = searchInput.value.toLowerCase(); const status = statusFilter.value; filteredPosts = allPosts.filter(post => { const titleMatch = post.title.toLowerCase().includes(searchTerm); const statusMatch = (status === 'all') || (post.status === status); return titleMatch && statusMatch; }); currentPage = 1; render(); }
    async function handleDeletePost(postId) { try { const response = await fetchWithAuth(`${API_URL}/${postId}`, { method: 'DELETE', }); if (!response.ok) throw new Error('Xóa thất bại.'); await fetchPosts(); } catch (error) { console.error(error); alert(error.message); } }

    // --- 5. GÁN CÁC EVENT LISTENER ---
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    paginationContainer.addEventListener('click', (e) => { const target = e.target.closest('.pagination-btn'); if (target && !target.disabled) { currentPage = parseInt(target.dataset.page); render(); } });
    
    tableBody.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-btn');
        const editButton = e.target.closest('.edit-btn');
        if (deleteButton) { postIdToDelete = deleteButton.dataset.id; deleteModal.classList.remove('hidden'); }
        if (editButton) { const postId = editButton.dataset.id; openEditModal(postId); }
    });

    cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.add('hidden'); postIdToDelete = null; });
    confirmDeleteBtn.addEventListener('click', () => { if (postIdToDelete) { handleDeletePost(postIdToDelete); deleteModal.classList.add('hidden'); postIdToDelete = null; } });

    closeEditModalBtn.addEventListener('click', closeEditModal);
    cancelEditBtn.addEventListener('click', closeEditModal);
    editForm.addEventListener('submit', handleUpdatePost);
    editFileUpload.addEventListener('change', (e) => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { editPreviewImage.src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });

    // --- 6. KHỞI CHẠY LẦN ĐẦU ---
    fetchPosts();
});</script> -->
<script>
  async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('authToken');

    // Tạo headers mặc định
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
    };

    // Thêm token vào header nếu có
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    // Nếu body là FormData, không cần Content-Type
    if (options.body instanceof FormData) {
        delete headers['Content-Type'];
    }

    const response = await fetch(url, { ...options, headers });

    // Xử lý khi token hết hạn hoặc không hợp lệ
    if (response.status === 401) {
        // Xóa token cũ
        localStorage.removeItem('authToken');
        // Thông báo và chuyển hướng về trang đăng nhập
        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
        window.location.href = './login.html'; // Sửa đường dẫn nếu cần
        // Ném lỗi để dừng các xử lý tiếp theo
        throw new Error('Unauthorized');
    }

    return response;
}
  document.addEventListener("DOMContentLoaded", () => {
      // =================================================================
      // LOGIC ĐIỀU KHIỂN DROPDOWN ADMIN (PHẦN BỊ THIẾU)
      // =================================================================
      const adminDropdownButton = document.querySelector(".dropdown button");
      const adminDropdownMenu = document.querySelector(".dropdown-menu");
  
      if (adminDropdownButton && adminDropdownMenu) {
          adminDropdownButton.addEventListener("click", (event) => {
              event.stopPropagation(); // Ngăn sự kiện click lan ra ngoài
              // Chuyển đổi trạng thái hiển thị của menu
              adminDropdownMenu.classList.toggle("opacity-0");
              adminDropdownMenu.classList.toggle("scale-95");
              adminDropdownMenu.classList.toggle("pointer-events-none");
              adminDropdownMenu.classList.toggle("opacity-100");
              adminDropdownMenu.classList.toggle("scale-100");
              adminDropdownMenu.classList.toggle("pointer-events-auto");
          });
  
          // Đóng dropdown khi click ra bên ngoài
          window.addEventListener("click", (event) => {
              if (!adminDropdownMenu.classList.contains('opacity-0') && !adminDropdownButton.contains(event.target)) {
                   adminDropdownMenu.classList.add("opacity-0", "scale-95", "pointer-events-none");
                   adminDropdownMenu.classList.remove("opacity-100", "scale-100", "pointer-events-auto");
              }
          });
      }
  
      // =================================================================
      // PHẦN CODE HIỆN TẠI CỦA BẠN (ĐƯỢC ĐƯA VÀO BÊN TRONG DOMCONTENTLOADED)
      // =================================================================
  
      const sidebar = document.querySelector(".sidebar");
const sidebarOverlay = document.getElementById("sidebar-overlay");
const sidebarToggle = document.getElementById("sidebarToggle"); // Giả sử nút toggle của bạn có id="sidebarToggle"

function openSidebar() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.add("active");
        sidebarOverlay.classList.remove("hidden");
    }
}

function closeSidebar() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.remove("active");
        sidebarOverlay.classList.add("hidden");
    }
}

// 1. Nhấn vào nút toggle để mở/đóng
if (sidebarToggle) {
    sidebarToggle.addEventListener("click", (e) => {
        e.stopPropagation(); // Ngăn sự kiện click lan ra ngoài
        if (sidebar.classList.contains("active")) {
            closeSidebar();
        } else {
            openSidebar();
        }
    });
}

// 2. Nhấn vào lớp overlay để đóng
if (sidebarOverlay) {
    sidebarOverlay.addEventListener("click", () => {
        closeSidebar();
    });
}

// 3. (Tùy chọn) Nhấn phím Escape để đóng
document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && sidebar.classList.contains("active")) {
        closeSidebar();
    }
});


      // --- 1. KHAI BÁO BIẾN VÀ HẰNG SỐ ---
      const POSTS_LIST_API_URL = "https://backendblog-production-3ce5.up.railway.app/api/posts/admin/all";
      const POST_RESOURCE_API_URL = "https://backendblog-production-3ce5.up.railway.app/api/posts";
      // const API_URL = "https://backendblog-production-3ce5.up.railway.app/api/posts/admin/all";
      const POSTS_PER_PAGE = 10;
  
      // DOM Elements - Trang chính
      const tableBody = document.getElementById("postsTableBody");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");
      const paginationContainer = document.getElementById("pagination");
  
      // DOM Elements - Modal Xóa
      const deleteModal = document.getElementById('delete-confirm-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
      const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
  
      // DOM Elements - Modal Chỉnh sửa
      const editModal = document.getElementById('edit-modal');
      const editForm = document.getElementById('edit-form');
      const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
      const cancelEditBtn = document.getElementById('cancel-edit-btn');
      const editPostIdInput = document.getElementById('edit-post-id');
      const editTitleInput = document.getElementById('edit-title');
      const editSlugInput = document.getElementById('edit-slug');
      const editExcerptTextarea = document.getElementById('edit-excerpt');
      const editFileUpload = document.getElementById('edit-file-upload');
      const editPreviewImage = document.getElementById('edit-preview-image');
  
      // DOM Elements - Modal Thông báo
      const notificationModal = document.getElementById("notification-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalMessage = document.getElementById("modal-message");
      const modalIconSuccess = document.getElementById("modal-icon-success");
      const modalIconError = document.getElementById("modal-icon-error");
      const modalCloseBtn = document.getElementById("modal-close-btn");
  
      // Biến trạng thái
      let allPosts = [];
      let filteredPosts = [];
      let currentPage = 1;
      let postIdToDelete = null;
      let editEditorInstance = null;
      
      // --- CÁC HÀM TIỆN ÍCH (MODAL THÔNG BÁO) ---
      function showModal(title, message, type = 'error') {
          if (!notificationModal) {
              alert(`[${type.toUpperCase()}] ${title}\n${message.replace(/<[^>]*>?/gm, '')}`);
              return;
          }
          modalTitle.textContent = title;
          modalMessage.innerHTML = message;
          if (type === 'success') {
              modalIconSuccess.classList.remove('hidden');
              modalIconError.classList.add('hidden');
          } else {
              modalIconError.classList.remove('hidden');
              modalIconSuccess.classList.add('hidden');
          }
          notificationModal.classList.remove('hidden');
      }
  
      function hideModal() {
          if (notificationModal) {
              notificationModal.classList.add('hidden');
          }
      }
      if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
      if(notificationModal) {
          notificationModal.addEventListener('click', (e) => {
              if (e.target === notificationModal) {
                  hideModal();
              }
          });
      }
  
      // --- Cấu hình CKEditor Upload Adapter ---
      class MyUploadAdapter {
          constructor(loader) { this.loader = loader; }
          upload() {
              return this.loader.file.then(file => new Promise((resolve, reject) => {
                  const data = new FormData();
                  data.append("upload", file);
                  fetchWithAuth("https://backendblog-production-3ce5.up.railway.app/api/upload", { method: "POST", body: data })
                      .then(response => response.json())
                      .then(result => resolve({ default: result.url }))
                      .catch(err => reject(err));
              }));
          }
          abort() {}
      }
      function MyCustomUploadAdapterPlugin(editor) {
          editor.plugins.get("FileRepository").createUploadAdapter = (loader) => new MyUploadAdapter(loader);
      }
      
      // --- CÁC HÀM CORE ---
      async function fetchPosts() { try { const response = await fetchWithAuth(POSTS_LIST_API_URL); if (!response.ok) throw new Error("Network response was not ok"); allPosts = await response.json(); filteredPosts = [...allPosts]; currentPage = 1; render(); } catch (error) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-red-500">${error.message}</td></tr>`; } }
      function renderTable() { if (filteredPosts.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-gray-500">Không có bài viết nào.</td></tr>`; return; } const startIndex = (currentPage - 1) * POSTS_PER_PAGE; const endIndex = startIndex + POSTS_PER_PAGE; const postsForCurrentPage = filteredPosts.slice(startIndex, endIndex); tableBody.innerHTML = postsForCurrentPage.map(post => { const statusClass = post.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'; const statusText = post.status === 'published' ? 'Đã đăng' : 'Nháp'; const authorName = post.author ? post.author.name : 'Admin'; return `<tr><td class="px-6 py-4"><div class="flex items-center"><div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-md object-cover" src="${post.image_url || 'https://via.placeholder.com/150'}" alt="${post.title}"></div><div class="ml-4"><div class="text-sm font-medium text-gray-900 truncate" style="max-width: 250px;">${post.title}</div><div class="text-sm text-gray-500">${post.slug}</div></div></div></td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${authorName}</div></td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${new Date(post.created_at).toLocaleDateString('vi-VN')}</div></td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><div class="flex space-x-2"><a href="#" class="edit-btn text-blue-600 hover:text-blue-900" data-id="${post.id}" title="Chỉnh sửa"><i data-feather="edit" class="w-4 h-4"></i></a><button class="delete-btn text-red-600 hover:text-red-900" data-id="${post.id}" title="Xóa"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></td></tr>`; }).join(''); feather.replace(); }
      function renderPagination() { const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE); if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; } let paginationHTML = `<div class="text-sm text-gray-500">Hiển thị <span class="font-medium">${(currentPage - 1) * POSTS_PER_PAGE + 1}</span> đến <span class="font-medium">${Math.min(currentPage * POSTS_PER_PAGE, filteredPosts.length)}</span> của <span class="font-medium">${filteredPosts.length}</span> kết quả</div><div class="flex space-x-2">`; paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Trước</button>`; for (let i = 1; i <= totalPages; i++) { const isActive = i === currentPage; paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${isActive ? 'border-blue-600 text-white bg-blue-600' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${i}">${i}</button>`; } paginationHTML += `<button class="pagination-btn px-3 py-1 rounded-md border ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'border-gray-300 text-gray-700 bg-white hover:bg-gray-50'}" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Sau</button>`; paginationHTML += `</div>`; paginationContainer.innerHTML = paginationHTML; }
      function render() { renderTable(); renderPagination(); }
      
      // --- LOGIC MODAL CHỈNH SỬA ---
      async function openEditModal(postId) { try { const response = await fetchWithAuth(`${POST_RESOURCE_API_URL}/${postId}`); if (!response.ok) { throw new Error("Không thể tải dữ liệu chi tiết bài viết."); } const post = await response.json(); editPostIdInput.value = post.id; editTitleInput.value = post.title; editSlugInput.value = post.slug; editExcerptTextarea.value = post.summary || ''; editPreviewImage.src = post.image_url; editFileUpload.value = ''; editModal.classList.remove('hidden'); feather.replace(); if (editEditorInstance) { await editEditorInstance.destroy(); editEditorInstance = null; } const editor = await ClassicEditor.create(document.querySelector("#edit-editor"), { extraPlugins: [MyCustomUploadAdapterPlugin], initialData: post.content || '' }); editEditorInstance = editor; } catch (error) { console.error("Lỗi khi mở modal chỉnh sửa:", error); showModal("Thao tác thất bại", `Lỗi: ${error.message}`, 'error'); } }
      function closeEditModal() { editModal.classList.add('hidden'); if (editEditorInstance) { editEditorInstance.destroy().catch(error => console.error(error)); editEditorInstance = null; } }
      async function handleUpdatePost(e) { e.preventDefault(); const submitter = e.submitter; if (!submitter) return; const status = submitter.id === 'publish-btn' ? 'published' : 'draft'; const postId = editPostIdInput.value; const title = editTitleInput.value.trim(); const content = editEditorInstance.getData(); const errors = []; if (!title) { errors.push("<li>Tiêu đề không được để trống.</li>"); } if (!content || content.replace(/<(.|\n)*?>/g, '').trim().length === 0) { errors.push("<li>Nội dung bài viết không được để trống.</li>"); } if (errors.length > 0) { showModal("Dữ liệu không hợp lệ", `<ul class="list-disc list-inside">${errors.join("")}</ul>`, 'error'); return; } const formData = new FormData(); formData.append('title', title); formData.append('slug', editSlugInput.value.trim()); formData.append('summary', editExcerptTextarea.value.trim()); formData.append('content', content); formData.append('status', status); if (editFileUpload.files[0]) { formData.append('image', editFileUpload.files[0]); } submitter.textContent = 'Đang xử lý...'; submitter.disabled = true; try { const response = await fetchWithAuth(`${POST_RESOURCE_API_URL}/${postId}`, { method: 'PUT', body: formData }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || 'Cập nhật thất bại'); } closeEditModal(); showModal("Thành công!", "Bài viết đã được cập nhật thành công.", "success"); await fetchPosts(); } catch (error) { console.error(error); showModal("Thao tác thất bại", `Lỗi: ${error.message}`, 'error'); } finally { submitter.textContent = status === 'published' ? 'Xuất bản' : 'Lưu nháp'; submitter.disabled = false; } }
  
      // --- CÁC HÀM XỬ LÝ SỰ KIỆN KHÁC ---
      function applyFilters() { const searchTerm = searchInput.value.toLowerCase(); const status = statusFilter.value; filteredPosts = allPosts.filter(post => { const titleMatch = post.title.toLowerCase().includes(searchTerm); const statusMatch = (status === 'all') || (post.status === status); return titleMatch && statusMatch; }); currentPage = 1; render(); }
      async function handleDeletePost(postId) { try { const response = await fetchWithAuth(`${POST_RESOURCE_API_URL}/${postId}`, { method: 'DELETE' }); if (!response.ok) throw new Error('Xóa thất bại.'); showModal("Thành công", "Đã xóa bài viết.", "success"); await fetchPosts(); } catch (error) { console.error(error); showModal("Thất bại", `Lỗi: ${error.message}`, "error"); } }
  
      // --- GÁN CÁC EVENT LISTENER ---
      searchInput.addEventListener('input', applyFilters);
      statusFilter.addEventListener('change', applyFilters);
      paginationContainer.addEventListener('click', (e) => { const target = e.target.closest('.pagination-btn'); if (target && !target.disabled) { currentPage = parseInt(target.dataset.page); render(); } });
      
      tableBody.addEventListener('click', (e) => {
          const deleteButton = e.target.closest('.delete-btn');
          const editButton = e.target.closest('.edit-btn');
          if (deleteButton) { postIdToDelete = deleteButton.dataset.id; deleteModal.classList.remove('hidden'); }
          if (editButton) { const postId = editButton.dataset.id; openEditModal(postId); }
      });
  
      cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.add('hidden'); postIdToDelete = null; });
      confirmDeleteBtn.addEventListener('click', () => { if (postIdToDelete) { handleDeletePost(postIdToDelete); deleteModal.classList.add('hidden'); postIdToDelete = null; } });
  
      closeEditModalBtn.addEventListener('click', closeEditModal);
      cancelEditBtn.addEventListener('click', closeEditModal);
      editForm.addEventListener('submit', handleUpdatePost);
      editFileUpload.addEventListener('change', (e) => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { editPreviewImage.src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
  
      // --- KHỞI CHẠY LẦN ĐẦU ---
      fetchPosts();
  });
  </script>
</body>
</html>
